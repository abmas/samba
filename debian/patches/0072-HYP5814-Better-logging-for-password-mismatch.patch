From: Sridevi Arvindekar <sridevi.arvindekar@simplivity.com>
Date: Tue, 20 Feb 2018 04:39:38 -0500
Subject: HYP5814 - Better logging for password mismatch

---
 source4/heimdal/lib/gssapi/krb5/accept_sec_context.c | 13 ++++++++++++-
 1 file changed, 12 insertions(+), 1 deletion(-)

diff --git a/source4/heimdal/lib/gssapi/krb5/accept_sec_context.c b/source4/heimdal/lib/gssapi/krb5/accept_sec_context.c
index cfe27ac..b402f46 100644
--- a/source4/heimdal/lib/gssapi/krb5/accept_sec_context.c
+++ b/source4/heimdal/lib/gssapi/krb5/accept_sec_context.c
@@ -3,6 +3,10 @@
  * (Royal Institute of Technology, Stockholm, Sweden).
  * All rights reserved.
  *
+ * Copyright Â© Hewlett Packard Enterprise Development LP 2018
+ * Contributor - Sridevi Arvindekar (HPE).
+ * Added support for Hyper-V over SMB 3.
+ *
  * Redistribution and use in source and binary forms, with or without
  * modification, are permitted provided that the following conditions
  * are met:
@@ -429,7 +433,14 @@ gsskrb5_acceptor_start(OM_uint32 * minor_status,
 				    server, &indata, output_token);
 	} else if (kret) {
 	    *minor_status = kret;
-	    return GSS_S_FAILURE;
+	    /*
+	     * KRB5KRB_AP_ERR_BAD_INTEGRITY is returned for password mismatch.
+	     * For better logging, we map this error to GSS_S_DEFECTIVE_CREDENTIAL.
+	     */
+	    if (kret == KRB5KRB_AP_ERR_BAD_INTEGRITY) {
+	        return GSS_S_DEFECTIVE_CREDENTIAL;
+	    } else
+	        return GSS_S_FAILURE;
 	}
 
 	/*
